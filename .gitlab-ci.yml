stages:
  - test
  - security
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  POSTGRES_DB: myblog_test
  POSTGRES_USER: test_user
  POSTGRES_PASSWORD: test_password
  POSTGRES_HOST_AUTH_METHOD: trust

services:
  - docker:20.10.16-dind
  - postgres:13

before_script:
  - echo "å¼€å§‹CI/CDæµæ°´çº¿..."

# ä»£ç è´¨é‡æ£€æŸ¥
lint:
  stage: test
  image: python:3.11
  before_script:
    - pip install flake8 black isort
  script:
    - echo "ðŸ” æ£€æŸ¥ä»£ç é£Žæ ¼..."
    - flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
    - black --check .
    - isort --check-only .
  only:
    - main
    - develop
    - merge_requests

# å•å…ƒæµ‹è¯•
test:
  stage: test
  image: python:3.11
  services:
    - postgres:13
  variables:
    DATABASE_URL: "postgres://test_user:test_password@postgres:5432/myblog_test"
  before_script:
    - pip install -r requirements.txt
  script:
    - echo "ðŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
    - python manage.py test
    - echo "ðŸ“Š ç”Ÿæˆæµ‹è¯•è¦†ç›–çŽ‡æŠ¥å‘Š..."
    - coverage run --source='.' manage.py test
    - coverage report
    - coverage html
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - htmlcov/
  only:
    - main
    - develop
    - merge_requests

# å®‰å…¨æ‰«æ
security_scan:
  stage: security
  image: python:3.11
  before_script:
    - pip install bandit safety
  script:
    - echo "ðŸ”’ æ‰§è¡Œå®‰å…¨æ‰«æ..."
    - bandit -r . -f json -o bandit-report.json || true
    - safety check --json --output safety-report.json || true
  artifacts:
    paths:
      - bandit-report.json
      - safety-report.json
    expire_in: 1 week
  only:
    - main
    - develop
    - merge_requests

# Dockeré•œåƒæž„å»º
build_image:
  stage: build
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "ðŸ³ æž„å»ºDockeré•œåƒ..."
    - docker build -t $IMAGE_TAG .
    - docker push $IMAGE_TAG
    - echo "é•œåƒå·²æŽ¨é€åˆ°: $IMAGE_TAG"
  only:
    - main

# éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ
deploy_production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts
  script:
    - echo "ðŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ..."
    - |
      ssh $DEPLOY_USER@$DEPLOY_HOST << 'EOF'
        cd /home/ec2-user/myblog
        sudo docker-compose down
        sudo docker-compose pull
        sudo docker-compose up -d
        echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
        sleep 30
        # å¥åº·æ£€æŸ¥
        if curl -f http://localhost/health/; then
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
          exit 1
        fi
      EOF
  environment:
    name: production
    url: http://$DEPLOY_HOST
  only:
    - main
  when: manual  # æ‰‹åŠ¨è§¦å‘éƒ¨ç½²

# éƒ¨ç½²é€šçŸ¥
notify_deployment:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - echo "ðŸ“¢ å‘é€éƒ¨ç½²é€šçŸ¥..."
    - |
      curl -X POST -H 'Content-type: application/json' \
      --data "{\"text\":\"ðŸš€ åšå®¢ç³»ç»Ÿéƒ¨ç½²æˆåŠŸï¼\nðŸ“ æäº¤: $CI_COMMIT_MESSAGE\nðŸ‘¤ ä½œè€…: $CI_COMMIT_AUTHOR\nðŸ”— æŸ¥çœ‹: http://$DEPLOY_HOST\"}" \
      $SLACK_WEBHOOK_URL
  only:
    - main
  dependencies:
    - deploy_production
  when: on_success 